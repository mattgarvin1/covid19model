{
  "$graph": [
    {
      "baseCommand": [
        "bash",
        "/batch/docker-run.sh"
      ],
      "class": "CommandLineTool",
      "cwlVersion": "v1.0",
      "id": "#make-batches.cwl",
      "inputs": [
        {
          "id": "#make-batches.cwl/stateList",
          "type": "string"
        },
        {
          "id": "#make-batches.cwl/deathsCutoff",
          "type": "string"
        },
        {
          "id": "#make-batches.cwl/maxBatchSize",
          "type": "string"
        },
        {
          "id": "#make-batches.cwl/s3_bucket",
          "type": "string"
        }
      ],
      "outputs": [
        {
          "id": "#make-batches.cwl/batches",
          "outputBinding": {
            "glob": "batch*.txt",
            "loadContents": true
          },
          "type": {
            "items": "File",
            "type": "array"
          }
        }
      ],
      "requirements": [
        {
          "class": "EnvVarRequirement",
          "envDef": {
            "DEATHS_CUTOFF": "$(inputs.deathsCutoff)",
            "MAX_BATCH_SIZE": "$(inputs.maxBatchSize)",
            "S3_BUCKET": "$(inputs.s3_bucket)",
            "STATE_LIST": "$(inputs.stateList)",
            "WRITE_LIST_TO_S3": "false"
          }
        },
        {
          "class": "DockerRequirement",
          "dockerPull": "quay.io/cdis/make-county-batches:fix_order"
        },
        {
          "class": "ResourceRequirement",
          "coresMax": 2,
          "coresMin": 2,
          "ramMax": 16384,
          "ramMin": 16384
        }
      ]
    },
    {
      "baseCommand": [
        "bash",
        "/docker-run.sh"
      ],
      "class": "CommandLineTool",
      "cwlVersion": "v1.0",
      "id": "#model.cwl",
      "inputs": [
        {
          "id": "#model.cwl/batch",
          "type": "File"
        },
        {
          "id": "#model.cwl/s3_bucket",
          "type": "string"
        },
        {
          "id": "#model.cwl/nIter",
          "type": "string"
        },
        {
          "id": "#model.cwl/mode",
          "type": "string"
        },
        {
          "id": "#model.cwl/deathsCutoff",
          "type": "string"
        }
      ],
      "outputs": [
        {
          "id": "#model.cwl/output",
          "outputBinding": {
            "outputEval": "$('output')"
          },
          "type": "string"
        }
      ],
      "requirements": [
        {
          "class": "EnvVarRequirement",
          "envDef": {
            "BATCH": "$(inputs.batch.contents)",
            "DEATHS_CUTOFF": "$(inputs.deathsCutoff)",
            "MODEL_RUN_MODE": "$(inputs.mode)",
            "N_ITER": "$(inputs.nIter)",
            "S3_BUCKET": "$(inputs.s3_bucket)"
          }
        },
        {
          "class": "DockerRequirement",
          "dockerPull": "quay.io/cdis/bayes-by-county:fix_order"
        },
        {
          "class": "ResourceRequirement",
          "coresMax": 4,
          "coresMin": 4,
          "ramMax": 16384,
          "ramMin": 16384
        }
      ]
    },
    {
      "baseCommand": [
        "bash",
        "/batch/docker-run.sh"
      ],
      "class": "CommandLineTool",
      "cwlVersion": "v1.0",
      "id": "#write-county-list.cwl",
      "inputs": [
        {
          "id": "#write-county-list.cwl/stateList",
          "type": "string"
        },
        {
          "id": "#write-county-list.cwl/deathsCutoff",
          "type": "string"
        },
        {
          "id": "#write-county-list.cwl/maxBatchSize",
          "type": "string"
        },
        {
          "id": "#write-county-list.cwl/s3_bucket",
          "type": "string"
        },
        {
          "id": "#write-county-list.cwl/hold",
          "type": {
            "items": "string",
            "type": "array"
          }
        }
      ],
      "outputs": [
        {
          "id": "#write-county-list.cwl/batches",
          "outputBinding": {
            "glob": "batch*.txt",
            "loadContents": true
          },
          "type": {
            "items": "File",
            "type": "array"
          }
        }
      ],
      "requirements": [
        {
          "class": "EnvVarRequirement",
          "envDef": {
            "DEATHS_CUTOFF": "$(inputs.deathsCutoff)",
            "MAX_BATCH_SIZE": "$(inputs.maxBatchSize)",
            "S3_BUCKET": "$(inputs.s3_bucket)",
            "STATE_LIST": "$(inputs.stateList)",
            "WRITE_LIST_TO_S3": "true"
          }
        },
        {
          "class": "DockerRequirement",
          "dockerPull": "quay.io/cdis/make-county-batches:fix_order"
        },
        {
          "class": "ResourceRequirement",
          "coresMax": 2,
          "coresMin": 2,
          "ramMax": 16384,
          "ramMin": 16384
        }
      ]
    },
    {
      "class": "Workflow",
      "cwlVersion": "v1.0",
      "id": "#main",
      "inputs": [
        {
          "id": "#main/nIter",
          "type": "string"
        },
        {
          "id": "#main/mode",
          "type": "string"
        },
        {
          "id": "#main/s3_bucket",
          "type": "string"
        },
        {
          "id": "#main/stateList",
          "type": "string"
        },
        {
          "id": "#main/deathsCutoff",
          "type": "string"
        },
        {
          "id": "#main/maxBatchSize",
          "type": "string"
        }
      ],
      "outputs": [
        {
          "id": "#main/output",
          "outputSource": "#main/model/output",
          "type": {
            "items": "string",
            "type": "array"
          }
        }
      ],
      "steps": [
        {
          "id": "#main/make-batches",
          "in": [
            {
              "id": "#main/make-batches/maxBatchSize",
              "source": "#main/maxBatchSize"
            },
            {
              "id": "#main/make-batches/s3_bucket",
              "source": "#main/s3_bucket"
            },
            {
              "id": "#main/make-batches/stateList",
              "source": "#main/stateList"
            },
            {
              "id": "#main/make-batches/deathsCutoff",
              "source": "#main/deathsCutoff"
            }
          ],
          "out": [
            "#main/make-batches/batches"
          ],
          "run": "#make-batches.cwl"
        },
        {
          "id": "#main/model",
          "in": [
            {
              "id": "#main/model/nIter",
              "source": "#main/nIter"
            },
            {
              "id": "#main/model/mode",
              "source": "#main/mode"
            },
            {
              "id": "#main/model/deathsCutoff",
              "source": "#main/deathsCutoff"
            },
            {
              "id": "#main/model/batch",
              "source": "#main/make-batches/batches"
            },
            {
              "id": "#main/model/s3_bucket",
              "source": "#main/s3_bucket"
            }
          ],
          "out": [
            "#main/model/output"
          ],
          "run": "#model.cwl",
          "scatter": "#main/model/batch"
        },
        {
          "id": "#main/write-county-list",
          "in": [
            {
              "id": "#main/write-county-list/deathsCutoff",
              "source": "#main/deathsCutoff"
            },
            {
              "id": "#main/write-county-list/maxBatchSize",
              "source": "#main/maxBatchSize"
            },
            {
              "id": "#main/write-county-list/hold",
              "source": "#main/model/output"
            },
            {
              "id": "#main/write-county-list/s3_bucket",
              "source": "#main/s3_bucket"
            },
            {
              "id": "#main/write-county-list/stateList",
              "source": "#main/stateList"
            }
          ],
          "out": [
            "#main/write-county-list/batches"
          ],
          "run": "#write-county-list.cwl"
        }
      ]
    }
  ],
  "cwlVersion": "v1.0"
}
